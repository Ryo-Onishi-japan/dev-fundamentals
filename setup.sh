#!/bin/bash
# ↑ シバン(shebang): このスクリプトをbashシェルで実行することを指定
#   スクリプトを ./setup.sh で直接実行する場合に必要

# ============================================================
# AIコーディング環境セットアップスクリプト
# ============================================================
# 使用方法: bash setup.sh
# 
# このスクリプトは以下のツールをインストールします:
#   - Node.js (JavaScript実行環境)
#   - Gemini CLI (AIコーディングアシスタント)
#   - GitHub CLI (GitHubをコマンドラインから操作)
#   - mmcp (MCP管理ツール)
# ============================================================

set -e
# ↑ エラーが発生したらスクリプトを即座に終了する設定
#   これにより、途中でコマンドが失敗した場合に
#   後続の処理が実行されるのを防ぎます

echo "🚀 AIコーディング環境セットアップを開始します..."
# ↑ echo: 文字列を画面に表示するコマンド
#   ターミナルにメッセージを出力してユーザーに進捗を伝えます

# ------------------------------------------------------------
# ターミナルの色を定義（見やすい出力のため）
# ------------------------------------------------------------
GREEN='\033[0;32m'   # 緑色（成功メッセージ用）
YELLOW='\033[1;33m'  # 黄色（進捗メッセージ用）
NC='\033[0m'         # No Color - 色をリセット
# ↑ \033[...m はANSIエスケープコード
#   ターミナルの文字色を変更するための特殊な文字列です
#   ${GREEN}テキスト${NC} のように使用すると、テキストが緑色になります

# ============================================================
# [1/4] Node.js環境の確認とインストール
# ============================================================
# Node.jsとは: JavaScriptをブラウザ外で実行するための環境
# Gemini CLIやnpmパッケージを使うために必要です
# ------------------------------------------------------------
echo ""
echo "${YELLOW}[1/4] Node.js環境を確認中...${NC}"

if command -v node &> /dev/null; then
    # ↑ command -v: コマンドが存在するか確認
    #   &> /dev/null: 出力を破棄（画面に表示しない）
    #   if文と組み合わせて「nodeコマンドが存在するか」をチェック
    echo "${GREEN}✓ Node.js $(node --version) がインストール済みです${NC}"
    # ↑ $(node --version): コマンドの実行結果を文字列として埋め込む
    #   node --version は v20.11.0 のようなバージョン番号を返します
else
    echo "Node.jsが見つかりません。nvmをインストールします..."
    
    # nvmのインストール
    # nvm (Node Version Manager): Node.jsのバージョン管理ツール
    # 複数のNode.jsバージョンを切り替えて使えるようになります
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
    # ↑ curl: URLからデータを取得するコマンド
    #   -o-: 出力を標準出力へ（ファイルに保存しない）
    #   | bash: 取得したスクリプトをbashで実行
    #   ※ 信頼できるソースからのみ実行してください
    
    # nvmの環境変数を設定
    export NVM_DIR="$HOME/.nvm"
    # ↑ export: 環境変数を設定・公開するコマンド
    #   NVM_DIR: nvmのインストール先ディレクトリを指定
    #   $HOME: ユーザーのホームディレクトリ（例: /home/username）
    
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    # ↑ [ -s "..." ]: ファイルが存在し、サイズが0より大きいか確認
    #   && : 左側が成功したら右側を実行（AND条件）
    #   \. または source: スクリプトを現在のシェルで読み込む
    #   これによりnvmコマンドが使えるようになります
    
    # Node.jsのLTS（長期サポート）版をインストール
    nvm install --lts
    # ↑ --lts: Long Term Support版（安定版）をインストール
    #   本番環境でも推奨される安定したバージョンです
    
    echo "${GREEN}✓ Node.js をインストールしました${NC}"
fi

# ============================================================
# [2/4] Gemini CLIの確認とインストール
# ============================================================
# Gemini CLIとは: GoogleのAI「Gemini」をコマンドラインから使うツール
# ターミナルでAIにコードの質問やレビューを依頼できます
# ------------------------------------------------------------
echo ""
echo "${YELLOW}[2/4] Gemini CLIを確認中...${NC}"

if command -v gemini &> /dev/null; then
    echo "${GREEN}✓ Gemini CLI がインストール済みです${NC}"
else
    echo "Gemini CLIをインストールします..."
    
    npm install -g @anthropic-ai/gemini-cli
    # ↑ npm: Node.jsのパッケージマネージャー
    #   install: パッケージをインストール
    #   -g: グローバルインストール（システム全体で使用可能に）
    #   @anthropic-ai/gemini-cli: パッケージ名
    #   グローバルインストールすると、どのディレクトリからでも
    #   geminiコマンドが使えるようになります
    
    echo "${GREEN}✓ Gemini CLI をインストールしました${NC}"
    echo "初回起動時にGoogleアカウントでログインしてください"
fi

# ============================================================
# [3/4] GitHub CLIの確認とインストール
# ============================================================
# GitHub CLIとは: GitHubをコマンドラインから操作するツール
# リポジトリの作成、PRの作成、Issueの管理などができます
# ------------------------------------------------------------
echo ""
echo "${YELLOW}[3/4] GitHub CLIを確認中...${NC}"

if command -v gh &> /dev/null; then
    echo "${GREEN}✓ GitHub CLI がインストール済みです${NC}"
else
    echo "GitHub CLIをインストールします..."
    
    # OSの種類によってインストール方法を変える
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # ↑ $OSTYPE: 現在のOSの種類を表す環境変数
        #   "darwin"*: macOSの場合（darwinで始まる）
        #   [[ ... ]]: 拡張テストコマンド（より強力な条件判定）
        #   *: ワイルドカード（任意の文字列にマッチ）
        
        brew install gh
        # ↑ brew: macOS用パッケージマネージャー（Homebrew）
        #   macOSではHomebrewを使ってインストール
    else
        # Linux（Ubuntu/Debian）の場合
        sudo apt install -y gh
        # ↑ sudo: 管理者権限でコマンドを実行
        #   apt: Debian/Ubuntu系Linuxのパッケージマネージャー
        #   install: パッケージをインストール
        #   -y: 確認プロンプトに自動で「yes」と回答
    fi
    
    echo "${GREEN}✓ GitHub CLI をインストールしました${NC}"
fi

# ============================================================
# [4/4] mmcpの確認とインストール
# ============================================================
# mmcpとは: MCP (Model Context Protocol) 管理ツール
# AIツールが外部サービスと連携するための設定を管理します
# ------------------------------------------------------------
echo ""
echo "${YELLOW}[4/4] mmcp (MCP管理ツール)を確認中...${NC}"

if command -v mmcp &> /dev/null; then
    echo "${GREEN}✓ mmcp がインストール済みです${NC}"
else
    echo "mmcpをインストールします..."
    
    npm install -g mmcp
    # ↑ Gemini CLIと同様にグローバルインストール
    
    echo "${GREEN}✓ mmcp をインストールしました${NC}"
fi

# ============================================================
# セットアップ完了メッセージ
# ============================================================
echo ""
echo "=========================================="
echo "${GREEN}✅ セットアップが完了しました！${NC}"
echo "=========================================="
echo ""
echo "次のステップ:"
echo "  1. gh auth login  # GitHub認証（初回のみ）"
echo "     # ↑ GitHubアカウントとCLIを連携させます"
echo "  2. gemini  # Gemini CLIを起動"
echo "     # ↑ AIアシスタントとの対話を開始"
echo ""
echo "ヒント:"
echo "  - 各ツールの使い方は --help オプションで確認できます"
echo "    例: gh --help, gemini --help"
echo ""
